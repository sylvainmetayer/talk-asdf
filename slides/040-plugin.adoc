[.transparency]
== Création d'un plugin en moins de 10min

image::devoxx/DevoxxFR2024_0046.jpg[background, size=fill]

image::clock.webp[alt='Vite, vite !']

=== Présentation de l'outil

`sops` : Simple and flexible tool for managing secretsfootnote:[link:https://sops.talks.sylvain.dev[Instant Pub] !]

<https://github.com/getsops/sops>

=== Template

<https://github.com/asdf-vm/asdf-plugin-template>

image::template.png[alt='Template Github']

[%linenums,bash]
----
asdf plugin-add github-cli && asdf install github-cli latest && asdf global github-cli latest
gh repo create asdf-sops --template asdf-vm/asdf-plugin-template --public
git clone git@github.com:sylvainmetayer/asdf-sops.git
----

=== Création du template

`bash setup.bash`

[%linenums,bash]
----
[...]
Setting up plugin: asdf-sops

author:        Sylvain
plugin repo:   https://github.com/sylvainmetayer/asdf-sops
license:       https://choosealicense.com/licenses/mit/


sops github:   https://github.com/getsops/sops
sops docs:     https://github.com/getsops/sops
sops test:     `sops -v`
After confirmation, the `main` will be replaced with the generated
template using the above information. Please ensure all seems correct.
Type `yes` if you want to continue.

----

`git push --force-with-lease && git grep TODO`

== Structure d'un plugin

[%linenums,bash]
----
.
├── bin
│   ├── download
│   ├── install
│   ├── latest-stable
│   └── list-all
├── lib
│   └── utils.bash
├── LICENSE
├── README.md
----

[%notitle]
=== !

[%linenums,bash]
.lib/utils.bash
----
GH_REPO="https://github.com/getsops/sops"
TOOL_NAME="sops"
TOOL_TEST="sops --version"

sort_versions() { /* ... */ }

list_github_tags() { /* ... */ }

list_all_versions() {/* ... */ }

download_release() {/* ... */ }

install_version() {/* ... */ }
----

[%auto-animate]
=== Téléchargement d'une version

[%linenums,bash]
.bin/download
----
release_file="$ASDF_DOWNLOAD_PATH/$TOOL_NAME"
download_release "$ASDF_INSTALL_VERSION" "$release_file"
----

[%auto-animate]
=== Téléchargement d'une version

[%linenums,bash,highlight=5|7]
.lib/utils.bash
----
download_release() {
 local version filename url
 version="$1"
 filename="$2"
 url="$GH_REPO/releases/download/v${version}/sops-$(get_platform)-$(get_arch)"
 echo "* Downloading $TOOL_NAME release $version..."
 curl "${curl_opts[@]}" -o "$filename" -C - "$url" || fail "Could not download $url"
}
----

[%auto-animate]
=== Installation d'une version

[%linenums,bash]
.bin/install
----
chmod +x "$ASDF_DOWNLOAD_PATH/$TOOL_NAME"
install_version "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" \
"$ASDF_INSTALL_PATH"
----

[%auto-animate]
=== Installation d'une version

[%linenums,bash,highlight=6-8]
.lib/utils.bash
----
install_version() {
 local install_type="$1"
 local version="$2"
 local install_path="${3%/bin}/bin"
 mkdir -p "$install_path"
 cp -r "$ASDF_DOWNLOAD_PATH"/* "$install_path"
 test -x "$install_path/$TOOL_NAME" || fail \
"Expected $install_path/$TOOL_NAME to be executable."
 echo "$TOOL_NAME $version installation was successful!"
}
----

[.notes]
****
https://asdf-vm.com/plugins/create.html#environment-variables-overview

ASDF_INSTALL_TYPE version / ref (tag ou pas)
****

=== Lister toutes les versions

[%linenums,bash]
.bin/list-all
----
list_github_tags | sort_versions | xargs echo
----
[%linenums,bash,highlight=3-7|1]
.lib/utils.bash
----
sort_versions() { /* regex magic */ }

list_github_tags() {
 git ls-remote --tags --refs "$GH_REPO" |
  grep -o 'refs/tags/.*' | cut -d/ -f3- |
  sed 's/^v//' # NOTE: You might want to adapt this sed to remove non-version strings from tags
}
----

=== Dernière version stable

[%linenums,bash]
.bin/latest-stable
----
redirect_url=$(curl -sI "$GH_REPO/releases/latest" | \
sed -n -e "s|^location: *||p" | sed -n -e "s|\r||p")
----

[%linenums,bash,highlight=4]
----
$ curl "$GH_REPO/releases/latest"
HTTP/2 302
server: GitHub.com
location: https://github.com/getsops/sops/releases/tag/v3.8.1
----

[.notes]
****
Si header location avec n° version présent, on prend ça comme latest, sinon on prend la première du `list-all`
****

[.columns]
=== Besoin de plus ?

[.column]
--
image::asdf_scripts_1.png[alt='scripts disponibles']
--

[.column]
--
image::asdf_scripts_2.png[alt='scripts disponibles']

link:https://asdf-vm.com/plugins/create.html#scripts-overview[Tous les scripts disponibles]
--

[.transparency]
== Testons ça

image::devoxx/DevoxxFR2024_0053.jpg[background, size=fill]

<https://github.com/sylvainmetayer/asdf-sops>

[%linenums,bash]
----
$ ./2-plugin-demo.sh
----
